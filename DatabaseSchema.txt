CREATE TABLE ADMIN
(
UserName VARCHAR2(10) CONSTRAINT ADMIN_PK PRIMARY KEY,
Password VARCHAR2(100) NOT NULL
)









CREATE TABLE GENRE
(
ID NUMBER CONSTRAINT GENRE_PK PRIMARY KEY,
Title VARCHAR2(15) UNIQUE NOT NULL
)









CREATE TABLE AWARD
(
ID NUMBER CONSTRAINT AWARD_PK PRIMARY KEY,
Title VARCHAR2(15) NOT NULL,
AwardDescription VARCHAR2(30) NOT NULL,
AwardReciever VARCHAR2(10) NOT NULL CHECK (AwardReciever IN ('Actor','Director','Movie'))
)









CREATE TABLE LANGUAGE
(
ID NUMBER CONSTRAINT LANGUAGE_PK PRIMARY KEY,
Title VARCHAR2(15) UNIQUE NOT NULL
)









CREATE TABLE USERS
(
ID NUMBER CONSTRAINT USER_PK PRIMARY KEY,
UserName VARCHAR2(30) UNIQUE NOT NULL,
Email VARCHAR2(30)UNIQUE NOT NULL,
Bio VARCHAR2(100),
Avatar VARCHAR2(100),
Password VARCHAR2(100) NOT NULL,
CreationDate DATE DEFAULT SYSDATE
) 









CREATE TABLE MOVIE
(
ID NUMBER CONSTRAINT MOVIE_PK PRIMARY KEY,
Title VARCHAR2(15) NOT NULL,
Duration NUMBER NOT NULL,
CoverPhoto VARCHAR2(100) NOT NULL,
Trailer VARCHAR2(100),
Description VARCHAR2(200) NOT NULL,
ReleaseDate DATE NOT NULL,
BoxOfficeEst NUMBER NOT NULL,
Country VARCHAR2(25) NOT NULL,
Language VARCHAR2(15) NOT NULL,
AvgRating NUMBER DEFAULT 0,
CONSTRAINT LANGUAGE_FK FOREIGN KEY(Language) REFERENCES LANGUAGE(Title)
)


CREATE TABLE MOVIE
(
ID NUMBER CONSTRAINT MOVIE_PK PRIMARY KEY,
Title VARCHAR2(15) NOT NULL,
Duration NUMBER NOT NULL,
CoverPhoto VARCHAR2(100) NOT NULL,
Poster VARCHAR2(100) NOT NULL,
Description VARCHAR2(200) NOT NULL,
ReleaseDate DATE NOT NULL,
Country VARCHAR2(25) NOT NULL,
Language VARCHAR2(15) NOT NULL,
AvgRating NUMBER DEFAULT 0,
CONSTRAINT LANGUAGE_FK FOREIGN KEY(Language) REFERENCES LANGUAGE(Title)
)
ALTER TABLE MOVIE MODIFY DESCRIPTION VARCHAR2(4000)
ALTER TABLE MOVIE MODIFY TITLE VARCHAR2(45)
ALTER TABLE MOVIE MODIFY TITLE VARCHAR2(65)









CREATE TABLE MOVIE_GENRE
(
MovieID NUMBER,
GenreID NUMBER,
CONSTRAINT MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT MOVIE_GENRE_FK FOREIGN KEY(GenreID) REFERENCES GENRE(ID)
)
ALTER TABLE MOVIE_GENRE ADD CONSTRAINT MOVIE_FK_CASCADE FOREIGN KEY (MovieID) REFERENCES MOVIE(ID) ON DELETE CASCADE









CREATE TABLE MOVIE_AWARD
(
MovieID NUMBER,
AwardID NUMBER,
CONSTRAINT MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT MOVIE_AWARD_FK FOREIGN KEY(AwardID) REFERENCES AWARD(ID),
RecieveDate DATE NOT NULL
)

CREATE TABLE MOVIE_AWARD
(
    MovieID NUMBER,
    AwardID NUMBER,
    RecieveDate DATE NOT NULL,
    CONSTRAINT MOVIE_AWARD_MOVIE_FK FOREIGN KEY (MovieID) REFERENCES MOVIE(ID),
    CONSTRAINT MOVIE_AWARD_AWARD_FK FOREIGN KEY (AwardID) REFERENCES AWARD(ID)
);
ALTER TABLE MOVIE_AWARD ADD CONSTRAINT MOVIE_AWARD_MOVIE_FK_CASCADE FOREIGN KEY (MOVIEID) REFERENCES MOVIE(ID) ON DELETE CASCADE
ALTER TABLE MOVIE_AWARD MODIFY RECIEVEDATE NUMBER(4)










CREATE TABLE WATCHLIST
(
MovieID NUMBER ,
UserID NUMBER,
AddedDate DATE DEFAULT SYSDATE,
CONSTRAINT WATCHLIST_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT WATCHLIST_USER_FK FOREIGN KEY(UserID) REFERENCES USER(ID)
)
CREATE TABLE WATCHLIST
(
MovieID NUMBER ,
UserID NUMBER,
AddedDate DATE DEFAULT SYSDATE,
CONSTRAINT FAVOURITE_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID) ON DELETE CASCADE,
CONSTRAINT FAVOURITE_USER_FK FOREIGN KEY(UserID) REFERENCES USERS(ID) ON DELETE CASCADE
)










CREATE TABLE WATCHHISTORY
(
MovieID NUMBER ,
UserID NUMBER,
AddedDate DATE DEFAULT SYSDATE,
CONSTRAINT WATCHLIST_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID) ON DELETE CASCADE,
CONSTRAINT WATCHLIST_USER_FK FOREIGN KEY(UserID) REFERENCES USER(ID) ON DELETE CASCADE
)









CREATE TABLE USER_REVIEW
(
MovieID NUMBER ,
UserID NUMBER,
Heading VARCHAR2(20),
Content VARCHAR2(200),
Rating NUMBER NOT NULL,
AddedDate DATE DEFAULT SYSDATE,
CONSTRAINT WATCHLIST_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID) ON DELETE CASCASDE,
CONSTRAINT WATCHLIST_USER_FK FOREIGN KEY(UserID) REFERENCES USERS(ID) ON DELETE CASCADE
)
CREATE TABLE USER_REVIEW
(
MovieID NUMBER ,
UserID NUMBER,
Heading VARCHAR2(20),
Content VARCHAR2(200),
Rating NUMBER NOT NULL,
AddedDate DATE DEFAULT SYSDATE,
CONSTRAINT USERREVIEW_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID) ON DELETE CASCADE,
CONSTRAINT USERREVIEW_USER_FK FOREIGN KEY(UserID) REFERENCES USERS(ID) ON DELETE CASCADE
)
ALTER TABLE USER_REVIEW MODIFY HEADING VARCHAR2(500);
ALTER TABLE USER_REVIEW MODIFY CONTENT VARCHAR2(4000)









CREATE TABLE CELEB
(
ID NUMBER CONSTRAINT CELEB_PK PRIMARY KEY,
Name VARCHAR2(30) NOT NULL,
Avatar VARCHAR2(100) NOT NULL,
Bio VARCHAR2(100),
Country VARCHAR2(25) NOT NULL
)
ALTER TABLE CELEB MODIFY BIO VARCHAR2(4000)
ALTER TABLE CELEB ADD (GENDER VARCHAR2(10) NOT NULL CHECK (GENDER IN ('Male','Female')))









CREATE TABLE MOVIE_CELEB
(
MovieID NUMBER,
CelebID NUMBER,
CelebType VARCHAR2(10) CHECK(CelebType IN ('Actor','Director')),
Role VARCHAR2(15) NOT NULL,
CONSTRAINT MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT CELEB_FK FOREIGN KEY(CelebID) REFERENCES CELEB(ID)
)


CREATE TABLE MOVIE_CELEB
(
MovieID NUMBER,
CelebID NUMBER,
CelebType VARCHAR2(10) CHECK(CelebType IN ('Actor','Director')),
Role VARCHAR2(15) NOT NULL,
CONSTRAINT MOVIE_CELEB_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT CELEB_FK FOREIGN KEY(CelebID) REFERENCES CELEB(ID)
)
ALTER TABLE MOVIE_CELEB MODIFY ROLE VARCHAR2(30)
ALTER TABLE MOVIE_CELEB DROP CONSTRAINT MOVIE_CELEB_MOVIE_FK
ALTER TABLE MOVIE_CELEB ADD CONSTRAINT MOVIE_CELEB_MOVIE_FK FOREIGN KEY (MOVIEID) REFERENCES MOVIE(ID) ON DELETE CASCADE









CREATE TABLE CELEB_AWARD
(
MovieID NUMBER,
CelebID NUMBER,
AwardID NUMBER,
CONSTRAINT MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT CELEB_FK FOREIGN KEY(CelebID) REFERENCES CELEB(ID),
CONSTRAINT CELEB_AWARD_FK FOREIGN KEY(AwardID) REFERENCES AWARD(ID),
RecieveDate DATE NOT NULL
)

CREATE TABLE CELEB_AWARD
(
MovieID NUMBER,
CelebID NUMBER,
AwardID NUMBER,
RecieveDate DATE NOT NULL,
CONSTRAINT CELEB_AWARD_MOVIE_FK FOREIGN KEY(MovieID) REFERENCES MOVIE(ID),
CONSTRAINT CELEB_AWARD_CELEB_FK FOREIGN KEY(CelebID) REFERENCES CELEB(ID),
CONSTRAINT CELEB_AWARD_FK FOREIGN KEY(AwardID) REFERENCES AWARD(ID)
)
ALTER TABLE CELEB_AWARD MODIFY RECIEVEDATE NUMBER(4)
ALTER TABLE CELEB_AWARD DROP CONSTRAINT CELEB_AWARD_MOVIE_FK
ALTER TABLE CELEB_AWARD ADD CONSTRAINT CELEB_AWARD_MOVIE_FK FOREIGN KEY (MOVIEID) REFERENCES MOVIE(ID) ON DELETE CASCADE










CREATE OR REPLACE TRIGGER MOVIE_REVIEW_TRIGGER
AFTER INSERT OR UPDATE OR DELETE ON USER_REVIEW
FOR EACH ROW
DECLARE
  movie_id NUMBER;
  avg_rating NUMBER;
BEGIN
  -- Determine the affected movie's ID
  IF INSERTING THEN
    movie_id := :NEW.MOVIEID;
  ELSIF UPDATING THEN
    movie_id := :NEW.MOVIEID;
  ELSIF DELETING THEN
    movie_id := :OLD.MOVIEID;
  END IF;

  -- Compute the average rating for that movie
  SELECT NVL(AVG(RATING), 0)
  INTO avg_rating
  FROM USER_REVIEW
  WHERE MOVIEID = movie_id;

  -- Update the movie's AvgRating
  UPDATE MOVIE
  SET AVGRATING = avg_rating
  WHERE ID = movie_id;
END;
/








DROP TRIGGER MOVIE_REVIEW_TRIGGER